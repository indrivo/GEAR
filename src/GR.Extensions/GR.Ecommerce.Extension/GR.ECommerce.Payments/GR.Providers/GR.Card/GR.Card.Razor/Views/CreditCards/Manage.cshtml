@{
    ViewData["Title"] = "Manage cards";
}

<div class="card small-card">
    <div class="card-body">
        <div class="d-flex pb-3">
            <a href="#" data-toggle="modal" data-target="#add-credit-card-modal" class='btn blue-btn'><span class="fa fa-plus"></span> Add new card</a>
        </div>
        <partial name="./Partial/_CreditCardsPartialView" />
    </div>
</div>

<div class="modal fade" id="add-credit-card-modal" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add a new credit card</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <partial name="./Partial/_AddNewCreditCardForm" />
            </div>
            <div class="modal-footer">
                <button type="button" class="btn gray-btn btn-regular" data-dismiss="modal">Close</button>
                <button type="submit" id="add-card-submit-btn" form="addCreditCardForm" class="btn blue-btn">Verify and save</button>
            </div>
        </div>
    </div>
</div>

@section Scripts{
    <script>
		$(document).ready(() => {
			$("#addCreditCardForm").on("submit",
				function(e) {
					const form = $("#addCreditCardForm");
					console.log(form);
					const isValid = form.valid();

					if (!isValid) {
						e.preventDefault();
						return false;
					}

					const data = form.serializeArray();
					submitRequest(data);
					e.preventDefault();
					return false;
				});
		});

		function submitRequest(params) {
			const toast = new ToastNotifier();
			$.ajax({
				type: "PUT",
				url: "@Url.Action("AddNewCard", "CardPayApi")",
				data: $.param(params)
			}).done((data) => {
				if (data.is_success) {
					toast.notifySuccess("Info", "The card was added successfully");
					$("#add-credit-card-modal").modal("hide");
					setTimeout(() => {
						location.reload();
					}, 1500);
				} else {
					toast.notifyErrorList(data.error_keys);
				}
			}).fail(e => {
				toast.notifyErrorList(e);
			});
		}
    </script>
}