!function(t){"object"==typeof exports&&"object"==typeof module?t(require("../../lib/codemirror"),require("../../mode/sql/sql")):"function"==typeof define&&define.amd?define(["../../lib/codemirror","../../mode/sql/sql"],t):t(CodeMirror)}(function(d){"use strict";var g,h,v,x,m={QUERY_DIV:";",ALIAS_KEYWORD:"AS"},b=d.Pos,y=d.cmpPos;function C(t){return"[object Array]"==Object.prototype.toString.call(t)}function A(t){return"string"==typeof t?t:t.text}function q(t,e){return C(e)&&(e={columns:e}),e.text||(e.text=t),e}function U(t){return g[t.toUpperCase()]}function j(t){var e={};for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r]);return e}function a(t,e){var r=t.length,n=A(e).substr(0,r);return t.toUpperCase()===n.toUpperCase()}function w(t,e,r,n){if(C(r))for(var o=0;o<r.length;o++)a(e,r[o])&&t.push(n(r[o]));else for(var i in r)if(r.hasOwnProperty(i)){var s=r[i];a(e,s=s&&!0!==s?s.displayText?{text:s.text,displayText:s.displayText}:s.text:i)&&t.push(n(s))}}function O(t){"."==t.charAt(0)&&(t=t.substr(1));for(var e=t.split(x+x),r=0;r<e.length;r++)e[r]=e[r].replace(new RegExp(x,"g"),"");return e.join(x)}function L(t){for(var e=A(t).split("."),r=0;r<e.length;r++)e[r]=x+e[r].replace(new RegExp(x,"g"),x+x)+x;var n=e.join(".");return"string"==typeof t?n:((t=j(t)).text=n,t)}function R(t,e){for(var r=t.split(/\s+/),n=0;n<r.length;n++)r[n]&&e(r[n].replace(/[,;]/g,""))}function k(t,e){for(var r=e.doc,n=r.getValue(),o=t.toUpperCase(),i="",s="",a=[],l={start:b(0,0),end:b(e.lastLine(),e.getLineHandle(e.lastLine()).length)},u=n.indexOf(m.QUERY_DIV);-1!=u;)a.push(r.posFromIndex(u)),u=n.indexOf(m.QUERY_DIV,u+1);a.unshift(b(0,0)),a.push(b(e.lastLine(),e.getLineHandle(e.lastLine()).text.length));for(var f=null,c=e.getCursor(),p=0;p<a.length;p++){if((null==f||0<y(c,f))&&y(c,a[p])<=0){l={start:f,end:a[p]};break}f=a[p]}if(l.start){var d=r.getRange(l.start,l.end,!1);for(p=0;p<d.length;p++){if(R(d[p],function(t){var e=t.toUpperCase();e===o&&U(i)&&(s=i),e!==m.ALIAS_KEYWORD&&(i=t)}),s)break}}return s}d.registerHelper("hint","sql",function(t,e){g=function(t){var e={};if(C(t))for(var r=t.length-1;0<=r;r--){var n=t[r];e[A(n).toUpperCase()]=q(A(n),n)}else if(t)for(var o in t)e[o.toUpperCase()]=q(o,t[o]);return e}(e&&e.tables);var r,n,o=e&&e.defaultTable,i=e&&e.disableKeywords;h=o&&U(o),"sql"===(r=t.doc.modeOption)&&(r="text/x-sql"),v=d.resolveMode(r).keywords,"sql"===(n=t.doc.modeOption)&&(n="text/x-sql"),x=d.resolveMode(n).identifierQuote||"`",o&&!h&&(h=k(o,t)),(h=h||[]).columns&&(h=h.columns);var s,a,l,u=t.getCursor(),f=[],c=t.getTokenAt(u);if(c.end>u.ch&&(c.end=u.ch,c.string=c.string.slice(0,u.ch-c.start)),c.string.match(/^[.`"\w@]\w*$/)?(l=c.string,s=c.start,a=c.end):(s=a=u.ch,l=""),"."==l.charAt(0)||l.charAt(0)==x)s=function(t,e,r,n){for(var o=!1,i=[],s=e.start,a=!0;a;)a="."==e.string.charAt(0),o=o||e.string.charAt(0)==x,s=e.start,i.unshift(O(e.string)),"."==(e=n.getTokenAt(b(t.line,e.start))).string&&(a=!0,e=n.getTokenAt(b(t.line,e.start)));var l=i.join(".");w(r,l,g,function(t){return o?L(t):t}),w(r,l,h,function(t){return o?L(t):t}),l=i.pop();var u=i.join("."),f=!1,c=u;if(!U(u)){var p=u;(u=k(u,n))!==p&&(f=!0)}var d=U(u);return d&&d.columns&&(d=d.columns),d&&w(r,l,d,function(t){var e=u;return 1==f&&(e=c),"string"==typeof t?t=e+"."+t:(t=j(t)).text=e+"."+t.text,o?L(t):t}),s}(u,c,f,t);else{var p=function(t,e){return"object"==typeof t?t.className=e:t={text:t,className:e},t};w(f,l,h,function(t){return p(t,"CodeMirror-hint-table CodeMirror-hint-default-table")}),w(f,l,g,function(t){return p(t,"CodeMirror-hint-table")}),i||w(f,l,v,function(t){return p(t.toUpperCase(),"CodeMirror-hint-keyword")})}return{list:f,from:b(u.line,s),to:b(u.line,a)}})});