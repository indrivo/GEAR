!function(t){"object"==typeof exports&&"object"==typeof module?t(require("../../lib/codemirror"),require("../htmlmixed/htmlmixed")):"function"==typeof define&&define.amd?define(["../../lib/codemirror","../htmlmixed/htmlmixed"],t):t(CodeMirror)}(function(y){"use strict";var S=["template","literal","msg","fallbackmsg","let","if","elseif","else","switch","case","default","foreach","ifempty","for","call","param","deltemplate","delcall","log","element"];y.defineMode("soy",function(d){var t=y.getMode(d,"text/plain"),p={html:y.getMode(d,{name:"text/html",multilineTagIndentFactor:2,multilineTagIndentPastTag:!1}),attributes:t,text:t,uri:t,trusted_resource_uri:t,css:y.getMode(d,"text/css"),js:y.getMode(d,{name:"text/javascript",statementIndent:2*d.indentUnit})};function u(t){return t[t.length-1]}function f(e,a,t){if(e.sol()){for(var n=0;n<a.indent&&e.eat(/\s/);n++);if(n)return null}var s=e.string,r=t.exec(s.substr(e.pos));r&&(e.string=s.substr(0,e.pos+r.index));var l=e.hideFirstChars(a.indent,function(){var t=u(a.localStates);return t.mode.token(e,t.state)});return e.string=s,l}function h(t,e){return{element:e,next:t}}function g(t){t.scopes&&(t.variables=t.scopes.element,t.scopes=t.scopes.next)}return{startState:function(){return{kind:[],kindTag:[],soyState:[],templates:null,variables:h(null,"ij"),scopes:null,indent:0,quoteKind:null,localStates:[{mode:p.html,state:y.startState(p.html)}]}},copyState:function(t){return{tag:t.tag,kind:t.kind.concat([]),kindTag:t.kindTag.concat([]),soyState:t.soyState.concat([]),templates:t.templates,variables:t.variables,scopes:t.scopes,indent:t.indent,quoteKind:t.quoteKind,localStates:t.localStates.map(function(t){return{mode:t.mode,state:y.copyState(t.mode,t.state)}})}},token:function(t,e){var a,n,s;switch(u(e.soyState)){case"comment":if(t.match(/^.*?\*\//)?e.soyState.pop():t.skipToEnd(),!e.scopes)for(var r=/@param\??\s+(\S+)/g,l=t.current();i=r.exec(l);)e.variables=h(e.variables,i[1]);return"comment";case"string":var i;return(i=t.match(/^.*?(["']|\\[\s\S])/))?i[1]==e.quoteKind&&(e.quoteKind=null,e.soyState.pop()):t.skipToEnd(),"string"}if(!e.soyState.length||"literal"!=u(e.soyState)){if(t.match(/^\/\*/))return e.soyState.push("comment"),"comment";if(t.match(t.sol()?/^\s*\/\/.*/:/^\s+\/\/.*/))return"comment"}switch(u(e.soyState)){case"templ-def":return(i=t.match(/^\.?([\w]+(?!\.[\w]+)*)/))?(e.templates=h(e.templates,i[1]),e.scopes=h(e.scopes,e.variables),e.soyState.pop(),"def"):(t.next(),null);case"templ-ref":return(i=t.match(/(\.?[a-zA-Z_][a-zA-Z_0-9]+)+/))?(e.soyState.pop(),"."==i[0][0]?"variable-2":"variable"):(t.next(),null);case"namespace-def":return(i=t.match(/^\.?([\w\.]+)/))?(e.soyState.pop(),"variable"):(t.next(),null);case"param-def":return(i=t.match(/^\w+/))?(e.variables=h(e.variables,i[0]),e.soyState.pop(),e.soyState.push("param-type"),"def"):(t.next(),null);case"param-ref":return(i=t.match(/^\w+/))?(e.soyState.pop(),"property"):(t.next(),null);case"param-type":return"}"==t.peek()?(e.soyState.pop(),null):t.eatWhile(/^([\w]+|[?])/)?"type":(t.next(),null);case"var-def":return(i=t.match(/^\$([\w]+)/))?(e.variables=h(e.variables,i[1]),e.soyState.pop(),"def"):(t.next(),null);case"tag":if(t.match(/^\/?}/))return"/template"==e.tag||"/deltemplate"==e.tag?(g(e),e.variables=h(null,"ij"),e.indent=0):("/for"!=e.tag&&"/foreach"!=e.tag||g(e),e.indent-=d.indentUnit*("/}"==t.current()||-1==S.indexOf(e.tag)?2:1)),e.soyState.pop(),"keyword";if(t.match(/^([\w?]+)(?==)/)){if("kind"==t.current()&&(i=t.match(/^="([^"]+)/,!1))){var o=i[1];e.kind.push(o),e.kindTag.push(e.tag);var c=p[o]||p.html;(m=u(e.localStates)).mode.indent&&(e.indent+=m.mode.indent(m.state,"","")),e.localStates.push({mode:c,state:y.startState(c)})}return"attribute"}return(i=t.match(/([\w]+)(?=\()/))?"variable callee":(i=t.match(/^["']/))?(e.soyState.push("string"),e.quoteKind=i,"string"):t.match(/(null|true|false)(?!\w)/)||t.match(/0x([0-9a-fA-F]{2,})/)||t.match(/-?([0-9]*[.])?[0-9]+(e[0-9]*)?/)?"atom":t.match(/(\||[+\-*\/%]|[=!]=|\?:|[<>]=?)/)?"operator":(i=t.match(/^\$([\w]+)/))?(a=e.variables,n=i[1],function(t,e){for(;t;){if(t.element===e)return!0;t=t.next}return!1}(a,n)?"variable-2":s?"variable":"variable-2 error"):(i=t.match(/^\w+/))?/^(?:as|and|or|not|in)$/.test(i[0])?"keyword":null:(t.next(),null);case"literal":return t.match(/^(?=\{\/literal})/)?(e.indent-=d.indentUnit,e.soyState.pop(),this.token(t,e)):f(t,e,/\{\/literal}/)}if(t.match(/^\{literal}/))return e.indent+=d.indentUnit,e.soyState.push("literal"),"keyword";if(i=t.match(/^\{([/@\\]?\w+\??)(?=$|[\s}]|\/[/*])/)){var m;if("/switch"!=i[1]&&(e.indent+=(/^(\/|(else|elseif|ifempty|case|fallbackmsg|default)$)/.test(i[1])&&"switch"!=e.tag?1:2)*d.indentUnit),e.tag=i[1],e.tag=="/"+u(e.kindTag))e.kind.pop(),e.kindTag.pop(),e.localStates.pop(),(m=u(e.localStates)).mode.indent&&(e.indent-=m.mode.indent(m.state,"",""));return e.soyState.push("tag"),"template"==e.tag||"deltemplate"==e.tag?e.soyState.push("templ-def"):"call"==e.tag||"delcall"==e.tag?e.soyState.push("templ-ref"):"let"==e.tag?e.soyState.push("var-def"):"for"==e.tag||"foreach"==e.tag?(e.scopes=h(e.scopes,e.variables),e.soyState.push("var-def")):"namespace"==e.tag?(e.soyState.push("namespace-def"),e.scopes||(e.variables=h(null,"ij"))):e.tag.match(/^@(?:param\??|inject|state)/)?e.soyState.push("param-def"):e.tag.match(/^(?:param)/)&&e.soyState.push("param-ref"),"keyword"}return t.eat("{")?(e.tag="print",e.indent+=2*d.indentUnit,e.soyState.push("tag"),"keyword"):f(t,e,/\{|\s+\/\/|\/\*/)},indent:function(t,e,a){var n=t.indent,s=u(t.soyState);if("comment"==s)return y.Pass;if("literal"==s)/^\{\/literal}/.test(e)&&(n-=d.indentUnit);else{if(/^\s*\{\/(template|deltemplate)\b/.test(e))return 0;/^\{(\/|(fallbackmsg|elseif|else|ifempty)\b)/.test(e)&&(n-=d.indentUnit),"switch"!=t.tag&&/^\{(case|default)\b/.test(e)&&(n-=d.indentUnit),/^\{\/switch\b/.test(e)&&(n-=d.indentUnit)}var r=u(t.localStates);return n&&r.mode.indent&&(n+=r.mode.indent(r.state,e,a)),n},innerMode:function(t){return t.soyState.length&&"literal"!=u(t.soyState)?null:u(t.localStates)},electricInput:/^\s*\{(\/|\/template|\/deltemplate|\/switch|fallbackmsg|elseif|else|case|default|ifempty|\/literal\})$/,lineComment:"//",blockCommentStart:"/*",blockCommentEnd:"*/",blockCommentContinue:" * ",useInnerComments:!1,fold:"indent"}},"htmlmixed"),y.registerHelper("wordChars","soy",/[\w$]/),y.registerHelper("hintWords","soy",S.concat(["delpackage","namespace","alias","print","css","debugger"])),y.defineMIME("text/x-soy","soy")});